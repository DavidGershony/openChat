<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:OpenChat.UI.ViewModels"
             xmlns:controls="using:OpenChat.UI.Controls"
             xmlns:asyncImageLoader="using:AsyncImageLoader"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="OpenChat.UI.Views.ChatView"
             x:DataType="vm:ChatViewModel">

    <Grid ColumnDefinitions="*,Auto" Background="{StaticResource BackgroundDarkBrush}">
        <!-- Main Chat Area -->
        <Grid Grid.Column="0" RowDefinitions="Auto,*,Auto">

            <!-- Chat Header -->
            <Border Grid.Row="0" Padding="16" Background="{StaticResource BackgroundLightBrush}"
                    BorderBrush="{StaticResource BorderDefaultBrush}" BorderThickness="0,0,0,1">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Chat Avatar -->
                    <Border Grid.Column="0" Width="44" Height="44" CornerRadius="22"
                            Background="{StaticResource NostrPurpleBrush}" Margin="0,0,12,0">
                        <TextBlock Text="{Binding ChatName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   FontSize="18" FontWeight="SemiBold" Foreground="White"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>

                    <!-- Chat Info -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                        <TextBlock Text="{Binding ChatName}" FontSize="16" FontWeight="SemiBold" />
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="{Binding ParticipantCount, StringFormat={}{0} participants}"
                                       Classes="muted" FontSize="12" IsVisible="{Binding IsGroup}" />
                            <TextBlock Text="Direct Message" Classes="muted" FontSize="12"
                                       IsVisible="{Binding !IsGroup}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Header Actions -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                        <Button Classes="icon" ToolTip.Tip="Search in chat">
                            <PathIcon Data="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                                      Width="20" Height="20" />
                        </Button>
                        <!-- Invite Button (Groups only) -->
                        <Button Classes="icon" Command="{Binding ShowInviteDialogCommand}"
                                ToolTip.Tip="Invite to Group" IsVisible="{Binding IsGroup}">
                            <PathIcon Data="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                                      Width="20" Height="20" />
                        </Button>
                        <!-- Profile/Metadata Toggle Button (DMs only) -->
                        <Button Classes="icon" Command="{Binding ToggleMetadataPanelCommand}"
                                ToolTip.Tip="Contact Info" IsVisible="{Binding !IsGroup}">
                            <Panel>
                                <!-- User icon when panel is closed -->
                                <PathIcon Data="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                                          Width="20" Height="20"
                                          IsVisible="{Binding !ShowMetadataPanel}" />
                                <!-- Close icon when panel is open -->
                                <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                          Width="20" Height="20"
                                          IsVisible="{Binding ShowMetadataPanel}" />
                            </Panel>
                        </Button>
                        <!-- Group Info Button -->
                        <Button Classes="icon" Command="{Binding ShowChatInfoCommand}" ToolTip.Tip="Group info"
                                IsVisible="{Binding IsGroup}">
                            <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"
                                      Width="20" Height="20" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

        <!-- Messages Area -->
        <ScrollViewer Grid.Row="1" x:Name="MessageScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding Messages}" Margin="16">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:MessageViewModel">
                        <controls:MessageBubble DataContext="{Binding}" Margin="0,4" />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Loading Indicator -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundDarkBrush}"
                IsVisible="{Binding IsLoading}" Opacity="0.9">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="8">
                <TextBlock Text="Loading..." Classes="secondary" FontSize="14" />
            </StackPanel>
        </Border>

        <!-- Message Input -->
        <Border Grid.Row="2" Padding="16" Background="{StaticResource BackgroundLightBrush}"
                BorderBrush="{StaticResource BorderDefaultBrush}" BorderThickness="0,1,0,0">
            <Grid ColumnDefinitions="Auto,*,Auto" Height="48">
                <!-- Attachment Button -->
                <Button Grid.Column="0" Classes="icon" Margin="0,0,8,0" ToolTip.Tip="Attach file">
                    <PathIcon Data="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"
                              Width="20" Height="20" />
                </Button>

                <!-- Text Input -->
                <TextBox Grid.Column="1" Text="{Binding MessageText}"
                         Watermark="Type a message..."
                         AcceptsReturn="False"
                         TextWrapping="NoWrap"
                         VerticalContentAlignment="Center">
                    <TextBox.KeyBindings>
                        <KeyBinding Gesture="Enter" Command="{Binding SendMessageCommand}" />
                    </TextBox.KeyBindings>
                </TextBox>

                <!-- Send Button -->
                <Button Grid.Column="2" Classes="primary" Margin="8,0,0,0"
                        Command="{Binding SendMessageCommand}"
                        IsEnabled="{Binding !IsSending}"
                        Width="48" Height="48" CornerRadius="24"
                        Padding="0" ToolTip.Tip="Send message">
                    <Panel>
                        <PathIcon Data="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"
                                  Width="22" Height="22" Foreground="White"
                                  IsVisible="{Binding !IsSending}" />
                        <TextBlock Text="..." FontSize="14" Foreground="White"
                                   IsVisible="{Binding IsSending}"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Panel>
                </Button>
            </Grid>
        </Border>
        </Grid>

        <!-- Metadata Panel (Right Side) -->
        <Border Grid.Column="1" Width="300"
                IsVisible="{Binding ShowMetadataPanel}"
                Background="{StaticResource BackgroundMediumBrush}"
                BorderBrush="{StaticResource BorderDefaultBrush}"
                BorderThickness="1,0,0,0">
            <Grid RowDefinitions="Auto,*">
                <!-- Panel Header -->
                <Border Grid.Row="0" Padding="16"
                        Background="{StaticResource BackgroundLightBrush}"
                        BorderBrush="{StaticResource BorderDefaultBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Contact Info" FontSize="16" FontWeight="SemiBold"
                                   VerticalAlignment="Center" />
                        <Button Grid.Column="1" Classes="icon"
                                Command="{Binding ToggleMetadataPanelCommand}"
                                ToolTip.Tip="Close">
                            <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                      Width="18" Height="18" />
                        </Button>
                    </Grid>
                </Border>

                <!-- Panel Content -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="16" Margin="16">
                        <!-- Loading State -->
                        <StackPanel IsVisible="{Binding IsLoadingMetadata}"
                                    HorizontalAlignment="Center" VerticalAlignment="Center"
                                    Spacing="12" Margin="0,40,0,0">
                            <Border Width="60" Height="60" CornerRadius="30"
                                    Background="{StaticResource SurfaceSecondaryBrush}"
                                    HorizontalAlignment="Center">
                                <TextBlock Text="..." FontSize="24" FontWeight="Bold"
                                           Foreground="{StaticResource TextMutedBrush}"
                                           HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <TextBlock Text="Loading profile..." Classes="muted"
                                       FontSize="14" HorizontalAlignment="Center" />
                        </StackPanel>

                        <!-- Metadata Content (when loaded) -->
                        <StackPanel IsVisible="{Binding !IsLoadingMetadata}" Spacing="20">
                            <!-- Avatar -->
                            <Border Width="100" Height="100" CornerRadius="50"
                                    Background="{StaticResource NostrPurpleBrush}"
                                    HorizontalAlignment="Center"
                                    ClipToBounds="True">
                                <Panel>
                                    <!-- Placeholder Initial (always behind) -->
                                    <TextBlock Text="{Binding ChatName[0]}"
                                               FontSize="36" FontWeight="Bold" Foreground="White"
                                               HorizontalAlignment="Center" VerticalAlignment="Center" />
                                    <!-- Profile Picture (loaded async from URL) -->
                                    <Image asyncImageLoader:ImageLoader.Source="{Binding MetadataPicture}"
                                           Width="100" Height="100"
                                           Stretch="UniformToFill"
                                           IsVisible="{Binding MetadataPicture, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                </Panel>
                            </Border>

                            <!-- Display Name -->
                            <StackPanel Spacing="4" HorizontalAlignment="Center">
                                <!-- Show DisplayName if available -->
                                <TextBlock Text="{Binding MetadataDisplayName}"
                                           FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding MetadataDisplayName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                <!-- Otherwise show Name -->
                                <TextBlock Text="{Binding MetadataName}"
                                           FontSize="20" FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding MetadataDisplayName, Converter={x:Static StringConverters.IsNullOrEmpty}}" />

                                <!-- Username -->
                                <TextBlock Text="{Binding MetadataUsername, StringFormat=@{0}}"
                                           Classes="secondary" FontSize="14"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding MetadataUsername, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            </StackPanel>

                            <!-- NIP-05 Verification -->
                            <Border Background="{StaticResource SurfaceSecondaryBrush}"
                                    CornerRadius="8" Padding="12"
                                    IsVisible="{Binding MetadataNip05, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                    <PathIcon Data="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"
                                              Width="16" Height="16"
                                              Foreground="{StaticResource StatusOnlineBrush}" />
                                    <TextBlock Text="{Binding MetadataNip05}"
                                               Classes="secondary" FontSize="13" />
                                </StackPanel>
                            </Border>

                            <!-- About -->
                            <StackPanel Spacing="6"
                                        IsVisible="{Binding MetadataAbout, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <TextBlock Text="About" Classes="muted" FontSize="12" FontWeight="SemiBold" />
                                <TextBlock Text="{Binding MetadataAbout}"
                                           TextWrapping="Wrap" Classes="secondary" FontSize="14" />
                            </StackPanel>

                            <!-- Public Key - Always show -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="Public Key" Classes="muted" FontSize="12" FontWeight="SemiBold" />
                                <Border Background="{StaticResource SurfaceSecondaryBrush}"
                                        CornerRadius="6" Padding="10">
                                    <TextBlock Text="{Binding MetadataNpub}"
                                               FontSize="11" FontFamily="Consolas, Courier New"
                                               TextWrapping="Wrap" Classes="secondary"
                                               IsVisible="{Binding MetadataNpub, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                </Border>
                                <!-- Fallback to ContactPublicKey if no Npub -->
                                <Border Background="{StaticResource SurfaceSecondaryBrush}"
                                        CornerRadius="6" Padding="10"
                                        IsVisible="{Binding MetadataNpub, Converter={x:Static StringConverters.IsNullOrEmpty}}">
                                    <TextBlock Text="{Binding ContactPublicKey}"
                                               FontSize="11" FontFamily="Consolas, Courier New"
                                               TextWrapping="Wrap" Classes="secondary" />
                                </Border>
                            </StackPanel>

                            <!-- Website -->
                            <StackPanel Spacing="6"
                                        IsVisible="{Binding MetadataWebsite, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <TextBlock Text="Website" Classes="muted" FontSize="12" FontWeight="SemiBold" />
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <PathIcon Data="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"
                                              Width="14" Height="14"
                                              Foreground="{StaticResource NostrPurpleLightBrush}" />
                                    <TextBlock Text="{Binding MetadataWebsite}"
                                               Foreground="{StaticResource NostrPurpleLightBrush}"
                                               FontSize="13" />
                                </StackPanel>
                            </StackPanel>

                            <!-- Lightning Address -->
                            <StackPanel Spacing="6"
                                        IsVisible="{Binding MetadataLud16, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <TextBlock Text="Lightning Address" Classes="muted" FontSize="12" FontWeight="SemiBold" />
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <PathIcon Data="M7 2v11h3v9l7-12h-4l4-8z"
                                              Width="14" Height="14"
                                              Foreground="{StaticResource StatusWarningBrush}" />
                                    <TextBlock Text="{Binding MetadataLud16}"
                                               Classes="secondary" FontSize="13" />
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Invite Dialog Overlay -->
        <Border Grid.ColumnSpan="2"
                IsVisible="{Binding ShowInviteDialog}"
                Background="#80000000"
                HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <Border Classes="card"
                    Background="{StaticResource BackgroundCardBrush}"
                    CornerRadius="16"
                    Padding="24"
                    Margin="20"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    MinWidth="400" MaxWidth="480">
                <StackPanel Spacing="20">
                    <!-- Header -->
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Invite to Group"
                                   FontSize="22" FontWeight="Bold"
                                   VerticalAlignment="Center" />
                        <Button Grid.Column="1" Classes="icon"
                                Command="{Binding CloseInviteDialogCommand}"
                                ToolTip.Tip="Close">
                            <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                      Width="20" Height="20" />
                        </Button>
                    </Grid>

                    <!-- Group ID Section -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Group ID (share this to invite others)"
                                   Classes="secondary" FontSize="13" FontWeight="SemiBold" />
                        <Grid ColumnDefinitions="*,Auto">
                            <Border Grid.Column="0" Background="{StaticResource SurfaceSecondaryBrush}"
                                    CornerRadius="8" Padding="12">
                                <SelectableTextBlock Text="{Binding GroupInviteLink}"
                                                     FontSize="11" FontFamily="Consolas, Courier New"
                                                     TextWrapping="Wrap"
                                                     Foreground="{StaticResource TextSecondaryBrush}" />
                            </Border>
                            <Button Grid.Column="1" Classes="icon" Margin="8,0,0,0"
                                    Command="{Binding CopyGroupLinkCommand}"
                                    ToolTip.Tip="Copy">
                                <PathIcon Data="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                                          Width="18" Height="18" />
                            </Button>
                        </Grid>
                    </StackPanel>

                    <Border Height="1" Background="{StaticResource BorderDefaultBrush}" Margin="0,4" />

                    <!-- Direct Invite Section -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Or invite by public key"
                                   Classes="secondary" FontSize="13" FontWeight="SemiBold" />
                        <TextBox Text="{Binding InvitePublicKey}"
                                 Watermark="npub1... or hex public key"
                                 AcceptsReturn="False" />
                        <Button Classes="primary"
                                Command="{Binding SendInviteCommand}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"
                                          Width="18" Height="18" />
                                <TextBlock Text="Send Invite" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Error Message -->
                    <TextBlock Text="{Binding InviteError}"
                               Foreground="{StaticResource StatusErrorBrush}"
                               FontSize="13"
                               TextWrapping="Wrap"
                               IsVisible="{Binding InviteError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />

                    <!-- Success Message -->
                    <TextBlock Text="{Binding InviteSuccess}"
                               Foreground="{StaticResource StatusOnlineBrush}"
                               FontSize="13"
                               HorizontalAlignment="Center"
                               IsVisible="{Binding InviteSuccess, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
