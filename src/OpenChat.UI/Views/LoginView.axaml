<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:OpenChat.Presentation.ViewModels"
             xmlns:converters="using:OpenChat.UI.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="700"
             x:Class="OpenChat.UI.Views.LoginView"
             x:DataType="vm:LoginViewModel">

    <UserControl.Resources>
        <converters:PngBytesToBitmapConverter x:Key="PngBytesToBitmapConverter" />
    </UserControl.Resources>

    <Grid Background="{StaticResource BackgroundDarkBrush}">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Border Classes="card" MaxWidth="480" MinHeight="500"
                    VerticalAlignment="Center" HorizontalAlignment="Center"
                    Margin="32">
                <StackPanel Spacing="24">

                    <!-- Logo/Header -->
                    <StackPanel Spacing="8" HorizontalAlignment="Center">
                        <Border Width="80" Height="80" CornerRadius="40"
                                Background="{StaticResource NostrPurpleBrush}">
                            <PathIcon Data="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
                                      Width="40" Height="40" Foreground="White" />
                        </Border>
                        <TextBlock Text="OpenChat" FontSize="28" FontWeight="Bold"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Secure messaging with Nostr + MLS"
                                   Classes="secondary" HorizontalAlignment="Center" />
                    </StackPanel>

                    <!-- Login Method Tabs -->
                    <Border Background="{StaticResource SurfaceSecondaryBrush}" CornerRadius="8" Padding="4">
                        <Grid ColumnDefinitions="*,*,*">
                            <Button Grid.Column="0" Classes="tab"
                                    Command="{Binding SelectLoginMethodCommand}"
                                    CommandParameter="{x:Static vm:LoginMethod.PrivateKey}">
                                <Button.Styles>
                                    <Style Selector="Button.tab">
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                                        <Setter Property="Padding" Value="12,8" />
                                        <Setter Property="CornerRadius" Value="6" />
                                        <Setter Property="HorizontalAlignment" Value="Stretch" />
                                    </Style>
                                    <Style Selector="Button.tab:pointerover /template/ ContentPresenter">
                                        <Setter Property="Background" Value="{StaticResource SurfaceTertiaryBrush}" />
                                    </Style>
                                </Button.Styles>
                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                    <PathIcon Data="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"
                                              Width="16" Height="16" />
                                    <TextBlock Text="Import Key" FontSize="13" />
                                </StackPanel>
                            </Button>
                            <Button Grid.Column="1" Classes="tab"
                                    Command="{Binding SelectLoginMethodCommand}"
                                    CommandParameter="{x:Static vm:LoginMethod.GenerateNew}">
                                <Button.Styles>
                                    <Style Selector="Button.tab">
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                                        <Setter Property="Padding" Value="12,8" />
                                        <Setter Property="CornerRadius" Value="6" />
                                        <Setter Property="HorizontalAlignment" Value="Stretch" />
                                    </Style>
                                </Button.Styles>
                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                    <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"
                                              Width="16" Height="16" />
                                    <TextBlock Text="New Key" FontSize="13" />
                                </StackPanel>
                            </Button>
                            <Button Grid.Column="2" Classes="tab"
                                    Command="{Binding SelectLoginMethodCommand}"
                                    CommandParameter="{x:Static vm:LoginMethod.ExternalSigner}">
                                <Button.Styles>
                                    <Style Selector="Button.tab">
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                                        <Setter Property="Padding" Value="12,8" />
                                        <Setter Property="CornerRadius" Value="6" />
                                        <Setter Property="HorizontalAlignment" Value="Stretch" />
                                    </Style>
                                </Button.Styles>
                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                    <PathIcon Data="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"
                                              Width="16" Height="16" />
                                    <TextBlock Text="Extension" FontSize="13" />
                                </StackPanel>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Error Message -->
                    <Border IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            Background="#3DEF4444" CornerRadius="8" Padding="12">
                        <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource StatusErrorBrush}"
                                   TextWrapping="Wrap" />
                    </Border>

                    <!-- Import Key Section -->
                    <StackPanel Spacing="12"
                                IsVisible="{Binding SelectedLoginMethod, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:LoginMethod.PrivateKey}}">
                        <TextBlock Text="Import your Nostr private key" FontWeight="SemiBold" />
                        <TextBlock Text="Enter your nsec or hex private key to login"
                                   Classes="secondary" FontSize="13" />
                        <TextBox Text="{Binding PrivateKeyInput}"
                                 Watermark="nsec1... or hex private key"
                                 PasswordChar="*" />
                        <Button Classes="primary" HorizontalAlignment="Stretch"
                                Command="{Binding ImportKeyCommand}"
                                IsEnabled="{Binding !IsLoading}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zm-9-4h2V9h-2v6zm0-8h2V5h-2v2z"
                                          Width="18" Height="18" IsVisible="{Binding !IsLoading}" />
                                <TextBlock Text="Import Key" IsVisible="{Binding !IsLoading}" />
                                <TextBlock Text="Importing..." IsVisible="{Binding IsLoading}" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Generate New Key Section -->
                    <StackPanel Spacing="12"
                                IsVisible="{Binding SelectedLoginMethod, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:LoginMethod.GenerateNew}}">
                        <TextBlock Text="Generate a new Nostr identity" FontWeight="SemiBold" />
                        <TextBlock Text="Create a brand new keypair for your Nostr identity"
                                   Classes="secondary" FontSize="13" />

                        <Button Classes="secondary" HorizontalAlignment="Stretch"
                                Command="{Binding GenerateNewKeyCommand}"
                                IsVisible="{Binding !ShowGeneratedKeys}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"
                                          Width="18" Height="18" />
                                <TextBlock Text="Generate New Identity" />
                            </StackPanel>
                        </Button>

                        <!-- Generated Keys Display -->
                        <Border IsVisible="{Binding ShowGeneratedKeys}"
                                Background="{StaticResource SurfaceSecondaryBrush}"
                                CornerRadius="8" Padding="16">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Your new Nostr identity" FontWeight="SemiBold"
                                           Foreground="{StaticResource NostrPurpleLightBrush}" />

                                <StackPanel Spacing="4">
                                    <TextBlock Text="Public Key (npub)" Classes="muted" FontSize="12" />
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBox Grid.Column="0" Text="{Binding GeneratedNpub}"
                                                 IsReadOnly="True" FontFamily="Consolas"
                                                 FontSize="11" />
                                        <Button Grid.Column="1" Classes="icon" Margin="4,0,0,0"
                                                Command="{Binding CopyNpubCommand}" ToolTip.Tip="Copy">
                                            <PathIcon Data="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                                                      Width="16" Height="16" />
                                        </Button>
                                    </Grid>
                                </StackPanel>

                                <StackPanel Spacing="4">
                                    <TextBlock Text="Private Key (nsec) - KEEP SECRET!" Classes="muted" FontSize="12" />
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBox Grid.Column="0" Text="{Binding GeneratedNsec}"
                                                 IsReadOnly="True" FontFamily="Consolas"
                                                 FontSize="11" PasswordChar="*" />
                                        <Button Grid.Column="1" Classes="icon" Margin="4,0,0,0"
                                                Command="{Binding CopyNsecCommand}" ToolTip.Tip="Copy">
                                            <PathIcon Data="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                                                      Width="16" Height="16" />
                                        </Button>
                                    </Grid>
                                </StackPanel>

                                <Border Background="#3DF59E0B" CornerRadius="4" Padding="8">
                                    <TextBlock Text="Save your private key securely! You will need it to recover your account."
                                               Foreground="{StaticResource StatusWarning}" FontSize="12"
                                               TextWrapping="Wrap" />
                                </Border>

                                <Button Classes="primary" HorizontalAlignment="Stretch"
                                        Command="{Binding UseGeneratedKeyCommand}">
                                    <TextBlock Text="Continue with this identity" />
                                </Button>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- External Signer Section -->
                    <StackPanel Spacing="12"
                                IsVisible="{Binding SelectedLoginMethod, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:LoginMethod.ExternalSigner}}">
                        <TextBlock Text="Connect with External Signer" FontWeight="SemiBold" />
                        <TextBlock Text="Use Amber, nsecBunker, or other NIP-46 compatible signers"
                                   Classes="secondary" FontSize="13" TextWrapping="Wrap" />

                        <!-- QR Code -->
                        <Border IsVisible="{Binding NostrConnectQrPngBytes, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Center"
                                Background="White" CornerRadius="8" Padding="8">
                            <Image Source="{Binding NostrConnectQrPngBytes, Converter={StaticResource PngBytesToBitmapConverter}}"
                                   Width="200" Height="200"
                                   Stretch="Uniform" />
                        </Border>

                        <!-- Scanning for request label (visible when waiting for signer) -->
                        <TextBlock Text="Scanning for request..."
                                   IsVisible="{Binding IsExternalSignerConnecting}"
                                   HorizontalAlignment="Center"
                                   Classes="secondary" FontSize="13" FontStyle="Italic" />

                        <!-- Help Text -->
                        <Border Background="#3D8B5CF6" CornerRadius="4" Padding="8">
                            <StackPanel Spacing="4">
                                <TextBlock Text="How to connect:" FontWeight="SemiBold" FontSize="12"
                                           Foreground="{StaticResource NostrPurpleLightBrush}" />
                                <TextBlock Text="1. Open your signer app (Amber, etc.)" FontSize="12" Classes="secondary" />
                                <TextBlock Text="2. Scan the QR code above" FontSize="12" Classes="secondary" />
                                <TextBlock Text="3. Approve the connection in your signer app" FontSize="12" Classes="secondary" />
                            </StackPanel>
                        </Border>

                        <!-- Or paste bunker URL manually -->
                        <TextBlock Text="Or paste a bunker URL manually" Classes="muted" FontSize="12"
                                   HorizontalAlignment="Center" Margin="0,8,0,0" />

                        <TextBox Text="{Binding BunkerUrl}"
                                 Watermark="bunker://pubkey?relay=wss://relay.example.com"
                                 TextWrapping="Wrap" />

                        <Button Classes="primary" HorizontalAlignment="Stretch"
                                Command="{Binding ConnectExternalSignerCommand}">
                            <TextBlock Text="Connect" />
                        </Button>
                    </StackPanel>

                </StackPanel>
            </Border>
        </ScrollViewer>
    </Grid>
</UserControl>
